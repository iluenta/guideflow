La clave: Gemini con web search habilitado puede buscar en tiempo real la informaciÃ³n de transporte pÃºblico que necesitamos.

ğŸ“¦ ImplementaciÃ³n Alternativa (Sin APIs de Pago)
1. FunciÃ³n para Obtener Info de Transporte con Gemini
typescript// lib/discovery/transit-search.ts
import { geminiREST } from '@/lib/ai/gemini-rest'

/**
 * BÃºsqueda web inteligente de transporte pÃºblico desde aeropuerto
 */
export async function searchAirportTransportOptions(
    airportCode: string,
    airportName: string,
    cityName: string,
    destinationCoords: [number, number],
    nearbyMetroStations: Array<{ name: string, lines: string[], distance_m: number }>
): Promise<{
    public_transport: Array<{
        type: 'metro' | 'train' | 'bus' | 'shuttle',
        name: string,
        route: string,
        frequency: string,
        duration: string,
        price: string,
        notes?: string
    }>,
    taxi: {
        price_range: string,
        duration: string,
        uber_available: boolean,
        notes?: string
    }
}> {
    
    const nearbyStationsText = nearbyMetroStations.length > 0
        ? `Las estaciones de metro mÃ¡s cercanas al destino son: ${nearbyMetroStations.slice(0, 3).map(s => `${s.name} (${s.distance_m}m, lÃ­neas ${s.lines.join('/')})`).join(', ')}`
        : 'No hay estaciones de metro identificadas cerca del destino'
    
    const prompt = `Busca informaciÃ³n actualizada sobre cÃ³mo llegar desde el aeropuerto ${airportName} (${airportCode}) al centro de ${cityName}.

ğŸ¯ **CONTEXTO DEL DESTINO:**
- Ciudad: ${cityName}
- ${nearbyStationsText}

ğŸ“‹ **INFORMACIÃ“N A BUSCAR:**

1. **Transporte PÃºblico desde ${airportCode}:**
   - Â¿QuÃ© lÃ­neas de metro/tren/autobÃºs conectan el aeropuerto con el centro?
   - Para cada opciÃ³n: nombre, ruta, frecuencia, duraciÃ³n, precio
   - Si hay estaciones de metro cercanas al destino mencionadas arriba, indica cÃ³mo conectar

2. **Taxi/VTC desde ${airportCode}:**
   - Precio estimado al centro de ${cityName}
   - Â¿Hay tarifa plana oficial?
   - Â¿EstÃ¡ disponible Uber/Bolt/Cabify/similar?
   - DuraciÃ³n estimada del trayecto

ğŸ” **ESTRATEGIA DE BÃšSQUEDA:**
- Busca en webs oficiales del aeropuerto
- Busca en autoridades de transporte pÃºblico de ${cityName}
- Busca en guÃ­as de viaje actualizadas (Wikivoyage, Rome2Rio web, etc.)

ğŸ“¤ **FORMATO DE RESPUESTA (JSON ESTRICTO):**
{
  "public_transport": [
    {
      "type": "metro",
      "name": "Metro LÃ­nea 8",
      "route": "Aeropuerto â†’ Nuevos Ministerios",
      "frequency": "Cada 5-10 minutos",
      "duration": "15 minutos",
      "price": "â‚¬5.00",
      "notes": "Suplemento aeropuerto incluido"
    }
  ],
  "taxi": {
    "price_range": "â‚¬30-40",
    "duration": "25-35 minutos",
    "uber_available": true,
    "notes": "Tarifa plana â‚¬30 oficial"
  }
}

âš ï¸ **IMPORTANTE:**
- Si no encuentras informaciÃ³n exacta, usa estimaciones razonables basadas en ciudades similares
- Prioriza fuentes oficiales sobre foros
- Si los precios han cambiado recientemente, usa los actualizados

RESPONDE SOLO CON EL JSON.`

    try {
        const response = await geminiREST('gemini-2.0-flash', prompt, {
            responseMimeType: 'application/json',
            temperature: 0.2,
            tools: [{
                type: 'web_search_20250305' as const,
                name: 'web_search'
            }]
        })
        
        const data = response?.data
        
        if (!data || !data.public_transport) {
            console.warn('[Transit Search] No data returned, using fallback')
            return {
                public_transport: [{
                    type: 'bus',
                    name: 'AutobÃºs del aeropuerto',
                    route: `${airportCode} â†’ Centro de ${cityName}`,
                    frequency: 'Consultar horarios',
                    duration: 'Variable',
                    price: 'Consultar',
                    notes: 'InformaciÃ³n no disponible. Consultar en el aeropuerto.'
                }],
                taxi: {
                    price_range: 'Consultar en el aeropuerto',
                    duration: 'Variable segÃºn trÃ¡fico',
                    uber_available: false,
                    notes: 'Verificar disponibilidad localmente'
                }
            }
        }
        
        return data
        
    } catch (error) {
        console.error('[Transit Search Error]', error)
        // Fallback bÃ¡sico
        return {
            public_transport: [{
                type: 'bus',
                name: 'Transporte pÃºblico',
                route: `${airportCode} â†’ ${cityName}`,
                frequency: 'Consultar',
                duration: 'Consultar',
                price: 'Consultar',
                notes: 'InformaciÃ³n no disponible en este momento'
            }],
            taxi: {
                price_range: 'Consultar en el aeropuerto',
                duration: 'Variable',
                uber_available: false
            }
        }
    }
}

/**
 * Buscar informaciÃ³n de autopistas con Gemini
 */
export async function searchHighwayInformation(
    cityName: string,
    countryCode: string
): Promise<{
    main_highways: string[],
    tolls: boolean,
    congestion_zones: boolean,
    notes: string
}> {
    
    const prompt = `Busca informaciÃ³n sobre autopistas y accesos por carretera a ${cityName}, ${countryCode}.

ğŸ“‹ **INFORMACIÃ“N REQUERIDA:**
1. Principales autopistas/autovÃ­as que llegan a la ciudad (con nombres/nÃºmeros)
2. Â¿Hay peajes (tolls) en estas autopistas?
3. Â¿Hay zonas de bajas emisiones o peajes urbanos (congestion charge)?
4. Notas importantes para conductores (lÃ­mites velocidad, restricciones, etc.)

ğŸ“¤ **FORMATO JSON:**
{
  "main_highways": ["A-1 (Norte)", "A-2 (Barcelona)", "M-30 (CircunvalaciÃ³n)"],
  "tolls": true,
  "congestion_zones": false,
  "notes": "Velocidad mÃ¡xima 120 km/h en autopistas"
}

Si no encuentras informaciÃ³n especÃ­fica, usa datos genÃ©ricos del paÃ­s.
RESPONDE SOLO CON JSON.`

    try {
        const response = await geminiREST('gemini-2.0-flash', prompt, {
            responseMimeType: 'application/json',
            temperature: 0.2,
            tools: [{
                type: 'web_search_20250305' as const,
                name: 'web_search'
            }]
        })
        
        return response?.data || {
            main_highways: ['Consultar GPS/Google Maps'],
            tolls: false,
            congestion_zones: false,
            notes: 'InformaciÃ³n no disponible'
        }
        
    } catch (error) {
        return {
            main_highways: ['Consultar GPS'],
            tolls: false,
            congestion_zones: false,
            notes: ''
        }
    }
}

2. Generador Principal Actualizado
typescript// lib/arrival/generator-final.ts
import { geocodeAddress } from '@/lib/maps/mapbox'
import { discoverNearbyAirports } from '@/lib/discovery/airports'
import { discoverMainTrainStations, discoverNearbyMetroStations } from '@/lib/discovery/stations'
import { findParkingNearby } from '@/lib/maps/overpass'
import { searchAirportTransportOptions, searchHighwayInformation } from '@/lib/discovery/transit-search'
import { geminiREST } from '@/lib/ai/gemini-rest'

export async function generateArrivalInstructions(address: string) {
    console.log('[ARRIVAL] Starting generation for:', address)
    
    // PASO 1: Geocodificar
    const geocoded = await geocodeAddress(address)
    if (!geocoded) throw new Error('No se pudo geocodificar la direcciÃ³n')
    
    const { coordinates, city, country } = geocoded
    console.log('[ARRIVAL] Location:', city, country)
    
    // PASO 2: Descubrir aeropuertos (Wikidata)
    const nearbyAirports = await discoverNearbyAirports(coordinates, 150)
    console.log('[ARRIVAL] Airports:', nearbyAirports.map(a => a.code))
    
    // PASO 3: Estaciones principales (Overpass)
    const mainStations = await discoverMainTrainStations(city || '', coordinates)
    
    // PASO 4: Metro cercano (Overpass)
    const nearbyMetro = await discoverNearbyMetroStations(coordinates, 1000)
    
    // PASO 5: Parking (Overpass)
    const parkingInfo = await findParkingNearby(coordinates, 500)
    
    // PASO 6: **NUEVO** - Buscar info de transporte con Gemini + Web Search
    const airportsWithTransit = await Promise.all(
        nearbyAirports.slice(0, 2).map(async (airport) => {
            const transitInfo = await searchAirportTransportOptions(
                airport.code,
                airport.name,
                city || airport.city,
                coordinates,
                nearbyMetro
            )
            
            return {
                ...airport,
                transport: transitInfo
            }
        })
    )
    
    // PASO 7: Info de carreteras
    const highwayInfo = await searchHighwayInformation(city || '', country || '')
    
    // PASO 8: Generar guÃ­a final
    const instructions = await generateInstructionsMarkdown({
        address: geocoded.place_name,
        city: city || '',
        country: country || '',
        airports: airportsWithTransit,
        mainStations,
        nearbyMetro,
        parkingInfo,
        highwayInfo
    })
    
    return {
        full_address: geocoded.place_name,
        coordinates: { lat: coordinates[1], lng: coordinates[0] },
        city,
        country_code: country,
        nearest_airport: nearbyAirports[0] || null,
        nearest_train_station: mainStations[0] || null,
        instructions
    }
}

3. Prompt Final para Generar Markdown
typescriptasync function generateInstructionsMarkdown(context: any) {
    const prompt = `Genera una guÃ­a de llegada completa en espaÃ±ol para un apartamento turÃ­stico.

ğŸ“ **UBICACIÃ“N:** ${context.address}

---

## DATOS RECOPILADOS

### AEROPUERTOS

${context.airports.length > 0 ? context.airports.map((airport: any) => `
**${airport.name} (${airport.code})** - ${airport.distance_km} km

**Transporte PÃºblico:**
${airport.transport.public_transport.map((t: any) => 
    `- **${t.name}** (${t.type}): ${t.route}. ${t.duration}, ${t.frequency}. Precio: ${t.price}. ${t.notes || ''}`
).join('\n')}

**Taxi/VTC:**
${airport.transport.taxi.price_range} (${airport.transport.taxi.duration})
${airport.transport.taxi.uber_available ? 'âœ… Uber/similar disponible' : 'âŒ Solo taxi tradicional'}
${airport.transport.taxi.notes || ''}
`).join('\n') : 'Sin aeropuertos cercanos (<150km)'}

### ESTACIONES DE TREN

${context.mainStations.length > 0 ? context.mainStations.map((s: any) =>
    `- ${s.name} (${s.distance_km} km) - ${s.type}`
).join('\n') : 'No se identificaron estaciones principales'}

### METRO CERCANO AL APARTAMENTO

${context.nearbyMetro.length > 0 ? context.nearbyMetro.slice(0, 3).map((m: any) =>
    `- ${m.name} (${m.distance_m}m) - LÃ­neas: ${m.lines.join(', ')}`
).join('\n') : 'No hay metro cerca (>1km)'}

### AUTOPISTAS

${context.highwayInfo.main_highways.join(', ')}
${context.highwayInfo.tolls ? 'âš ï¸ Autopistas de peaje' : 'âœ… Sin peajes'}
${context.highwayInfo.congestion_zones ? 'âš ï¸ Zona de bajas emisiones o peaje urbano' : ''}

### PARKING

${context.parkingInfo.has_regulated_parking ? 
`âš ï¸ Estacionamiento regulado
Parkings cercanos: ${context.parkingInfo.parking_zones.slice(0, 2).map((p: any) => p.name || 'Parking').join(', ')}` :
`âœ… Parking libre en la calle`}

---

ğŸ¯ **GENERA ESTA ESTRUCTURA:**

# CÃ³mo Llegar al Apartamento

## 1. Llegada en AviÃ³n âœˆï¸

${context.airports.length > 0 ? `
Para cada aeropuerto, crea subsecciones:

### Desde ${context.airports[0].name} (${context.airports[0].code})

#### OpciÃ³n A: Transporte PÃºblico (Recomendado)
[Usa los datos de "Transporte PÃºblico" arriba]
[IMPORTANTE: Si el destino tiene metro cercano, conecta las rutas. Ejemplo:]

1. Toma [bus/metro/tren del aeropuerto] lÃ­nea X
2. Viaja hasta [estaciÃ³n principal o conexiÃ³n]
3. ${context.nearbyMetro.length > 0 ? 
   `Transborda/camina hasta la estaciÃ³n ${context.nearbyMetro[0].name} (lÃ­neas ${context.nearbyMetro[0].lines.join('/')})` :
   'Desde ahÃ­, taxi corto (â‚¬5-10) o 15 min a pie'}

- â±ï¸ DuraciÃ³n: [suma tiempos]
- ğŸ’° Precio: [suma precios]

[Si hay varias opciones de transporte, lista la MÃS RÃPIDA y la MÃS ECONÃ“MICA]

#### OpciÃ³n B: Taxi/VTC
[Usa datos de "Taxi/VTC"]

#### OpciÃ³n C: Coche de Alquiler
[Menciona parking si aplica]
` : 'No hay aeropuertos cercanos. Llegar por tren o coche desde otras ciudades.'}

## 2. Llegada en Tren ğŸš‚

${context.mainStations.length > 0 ? `
### Desde ${context.mainStations[0].name}

[Calcula conexiÃ³n:]
${context.nearbyMetro.length > 0 ?
  `- Metro: LÃ­nea X hasta ${context.nearbyMetro[0].name}, luego ${context.nearbyMetro[0].distance_m}m a pie` :
  '- Taxi/Uber: â‚¬X-Y (Z minutos) | A pie: X minutos si <2km'}
` : 'Consulta estaciones de tren principales de la ciudad'}

## 3. Llegada en Coche ğŸš—

### Desde Autopistas
${context.highwayInfo.main_highways.join(', ')}
${context.highwayInfo.notes}

### Parking
[Usa datos de "PARKING" arriba]

---

ğŸš« **REGLAS:**
- USA solo datos proporcionados
- Si falta info: "Consultar en el aeropuerto/estaciÃ³n"
- TONO: Claro, amigable
- LONGITUD: 600-800 palabras

RESPONDE SOLO CON MARKDOWN.`

    const response = await geminiREST('gemini-2.0-flash', prompt, {
        responseMimeType: 'text/plain',
        temperature: 0.3,
        maxOutputTokens: 3000
    })

    return response?.data || '# Instrucciones de Llegada\n\n(Error al generar)'
}

ğŸ“Š Flujo de Datos Completo
mermaidgraph TD
    A[Usuario ingresa direcciÃ³n] --> B[Mapbox Geocoding]
    B --> C[Wikidata: Aeropuertos cercanos]
    C --> D[Overpass: Estaciones/Metro/Parking]
    D --> E[Gemini Web Search: Transporte desde aeropuerto]
    E --> F[Gemini Web Search: Autopistas]
    F --> G[Gemini: Generar Markdown final]
    G --> H[Guardar en BD + RAG]

ğŸ¯ Ventajas de Este Enfoque
âœ… 100% Gratis - Solo APIs abiertas
âœ… Global - Funciona en cualquier paÃ­s
âœ… Actualizado - Gemini busca precios actuales en web
âœ… Sin mantenimiento - No hay datasets manuales
âœ… Fallback inteligente - Si falla bÃºsqueda, da respuesta genÃ©rica Ãºtil
âœ… Contextual - Conecta aeropuertos con metro cercano al apartamento

ğŸ“¦ InstalaciÃ³n
bashnpm install axios
Variables de entorno:
envNEXT_PUBLIC_MAPBOX_TOKEN=pk.eyJ1...
# Gemini ya estÃ¡ configurado en tu proyecto

ğŸš€ Resultado Esperado (Londres)
markdown# CÃ³mo Llegar al Apartamento

## 1. Llegada en AviÃ³n âœˆï¸

### Desde London Heathrow (LHR) - 24 km

#### OpciÃ³n A: Transporte PÃºblico

**ğŸš‡ MÃS RÃPIDA: Heathrow Express**
1. Toma el Heathrow Express desde T2-T5
2. Viaja hasta Paddington Station (15 minutos)
3. Desde Paddington: Circle Line hasta King's Cross (500m del apartamento)

- â±ï¸ DuraciÃ³n: ~30 minutos
- ğŸ’° Precio: Â£25-37 + Â£2.80 metro

**ğŸ’° MÃS ECONÃ“MICA: Piccadilly Line**
1. Toma el metro Piccadilly Line desde cualquier terminal
2. Viaja directo hasta King's Cross St Pancras
3. Camina 5 minutos hasta el apartamento

- â±ï¸ DuraciÃ³n: 50-60 minutos
- ğŸ’° Precio: Â£5.60 (Oyster/Contactless)
- ğŸ• Frecuencia: Cada 5 minutos

#### OpciÃ³n B: Taxi/Black Cab
- ğŸ’° Precio: Â£60-90 (tarifa fija Â£80 a zonas centrales)
- â±ï¸ DuraciÃ³n: 45-60 minutos
- âœ… Uber disponible (precio similar)

## 2. Llegada en Tren ğŸš‚

### Desde London St Pancras International (Eurostar)
Â¡EstÃ¡s muy cerca! El apartamento estÃ¡ a solo 500m de la estaciÃ³n.

- ğŸš¶ A pie: 7 minutos por Pancras Road
- ğŸš‡ Metro: No necesario (muy cerca)

## 3. Llegada en Coche ğŸš—

### Desde Autopistas
- **M1 (Norte)**: Salida hacia A501 (Euston Road)
- **M25 (Ring Road)**: Junction 23, A1(M) hacia centro

âš ï¸ **Congestion Charge Zone:** Â£15/dÃ­a (7:00-18:00, L-V)

### Parking
âš ï¸ **Zona de estacionamiento muy regulado**

**Parkings recomendados:**
- King's Cross Car Park (400m) - Â£25/dÃ­a
- NCP Euston (600m) - Â£30/dÃ­a

ğŸ’¡ **Consejo:** El transporte pÃºblico es mucho mÃ¡s prÃ¡ctico en Londres.